name: ç”¨æˆ¶ä¸Šå‚³è«–æ–‡è‡ªå‹•è™•ç†

on:
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: "0 2,10,18 * * *" # æ¯å¤© 2:00, 10:00, 18:00 (UTC) åŸ·è¡Œï¼Œä¸€å¤©æ›´æ–°3æ¬¡

jobs:
  process-user-uploads:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # æœ€é•· 30 åˆ†é˜å…§è¦å®Œæˆï¼Œè™•ç†ç”¨æˆ¶ä¸Šå‚³å¯èƒ½éœ€è¦æ›´å¤šæ™‚é–“
    steps:
      - name: ç°½å‡ºç¨‹å¼ç¢¼å€‰åº«
        uses: actions/checkout@v4

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: å®‰è£ uv
        uses: astral-sh/setup-uv@v5

      - name: ä½¿ç”¨ uv å®‰è£ä¾è³´å¥—ä»¶
        run: uv sync

      - name: åŸ·è¡Œç”¨æˆ¶ä¸Šå‚³è«–æ–‡è™•ç†å·¥ä½œæµç¨‹
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # èƒŒæ™¯ keep-aliveï¼Œæ¯ 60 ç§’è¼¸å‡ºä¸€æ¬¡è¨Šæ¯ï¼Œé˜²æ­¢ GitHub idle timeout
          while true; do echo "ğŸŸ¡ Keep alive for upload processing... $(date)"; sleep 60; done &
          # åŸ·è¡Œç”¨æˆ¶ä¸Šå‚³è™•ç†ç¨‹å¼
          uv run python upload_processor.py
